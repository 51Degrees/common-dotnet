pool:
  name: Hosted VS2017
  
trigger:
  - master
  - develop
  - release/*
    
variables: 
  - group: CertificateVariables
  # Because we are pulling in a group, we need to define local variables 
  # using the name/value syntax.
  - name: RestoreBuildProjects
    value: '**/*.sln'
    # Projects to be run unit tests for
  - name: TestProjects
    value: '**/*[Tt]ests/*.csproj'
    # Projects to be published as NuGet packages
  - name: PublishProjects
    value: '**/*.csproj;!**/*[Tt]ests/*.csproj'
    # Access token for the git repository. Used by the git tag task.
  - name: system_accesstoken
    value: $(System.AccessToken)

steps:
# The lines below are needed to allow the pipeline access to the
# OAuth access token that controls write access to the git repository. 
# (Required for GitTag task)
- checkout: self
  persistCredentials: true
# Useful snippets for debugging.
# List all contents of a directory:
#- script: |
#    ls -d $(System.ArtifactsDirectory)/*

# Use a script to set the BuildConfiguration variable.
# If building from master then build the Release configuration. 
# Otherwise, build the Debug configuration.
- script: |
    echo Current branch is %BUILD_SOURCEBRANCHNAME%
    if %BUILD_SOURCEBRANCHNAME% == "master" (
        SET BUILD_CONFIG=Release
    ) else (
        SET BUILD_CONFIG=Debug
    )
    echo ##vso[task.setvariable variable=BuildConfiguration]%BUILD_CONFIG%
    echo BuildConfiguration set to '%BUILD_CONFIG%'
  displayName: 'Determine Build Configuration'
    
- task: NuGetToolInstaller@1
  displayName: 'Use NuGet 5.2.0'
  inputs:
    versionSpec: 5.2.0

- task: DotNetCoreCLI@2
  displayName: Restore
  inputs:
    command: restore
    projects: '$(RestoreBuildProjects)'

- task: gittools.gitversion.gitversion-task.GitVersion@4
  displayName: 'Determine Version Number'
  # Give this task a name so we can use the variables it sets later. 
  name: GitVersion
  inputs:
    preferBundledVersion: false

- task: DotNetCoreCLI@2
  displayName: Build
  inputs:
    projects: '$(RestoreBuildProjects)'
    arguments: '--configuration $(BuildConfiguration)'

- task: DotNetCoreCLI@2
  displayName: Test
  inputs:
    command: test
    projects: '$(TestProjects)'
    arguments: '--configuration $(BuildConfiguration) --collect "Code coverage"' 

# Index and publish symbol file to allow debugging.
- task: PublishSymbols@2
  displayName: 'Publish Symbols'
  inputs: 
    SearchPattern: '**/bin/**/*.pdb'
    SymbolServerType: 'TeamServices'
    SymbolsVersion: '$(GitVersion.NuGetVersion)'

# The nuget package version uses the BUILD_BUILDNUMER environment variable.
# This has been set by the GitVersion task above.
- task: DotNetCoreCLI@2
  displayName: 'Build NuGet Package'
  inputs:
    command: 'pack'
    packagesToPack: '$(PublishProjects)'
    versioningScheme: 'byEnvVar'
    versionEnvVar: 'BUILD_BUILDNUMBER'
    
# The secure file to download will be stored in the 
# Pipelines/Library/SecureFiles section in Azure DevOps.
- task: DownloadSecureFile@1
  displayName: 'Download Code Signing Certificate'
  name: CodeSigningCert
  inputs:
    secureFile: ' 51Degrees.mobi Code Signing Certificate.pfx'

# Sign the Nuget package with the file downloaded previously.
# The password is stored in the Pipelines/Library/VariableGroups
# section in Azure DevOps.
- task: NuGetCommand@2
  displayName: 'Sign NuGet Package'
  inputs:
    command: custom
    arguments: 'sign $(System.ArtifactsDirectory)\*.nupkg -CertificatePath "$(CodeSigningCert.secureFilePath)" -CertificatePassword $(CodeSigningCertPassword) -Timestamper http://timestamp.digicert.com'

# Push the package file to the internal feed. From there it can be
# Published to the public nuget feed when needed.
- task: DotNetCoreCLI@2
  displayName: 'Publish NuGet Package'
  inputs:
    command: 'push'
    packagesToPush: '$(Build.ArtifactStagingDirectory)/*.nupkg'
    nuGetFeedType: 'internal'
    publishVstsFeed: 'd2431f86-c1e6-4d8b-8d27-311cf3614847'
# Only do this if:
# 1. The build has been successful to this point
# 2. The branch being built is master or develop OR the ForcePushNuget 
#    variable has been set to true.
  condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), or(eq(variables['Build.SourceBranch'], 'refs/heads/develop'), eq('true', variables['ForcePushNuget']))))

# Add a tag to the git repository with the version number of
# the package that has just been published
- task: ATP.ATP-GitTag.GitTag.GitTag@5
  displayName: 'Tag Repo With Version Number'
  inputs:
    tagUser: 'Azure DevOps'
    tagEmail: 'CIUser@51Degrees.com'
    tag: 'v$(GitVersion.NuGetVersion)'
# Only create the tag if we also published a package as defined in 
# the previous task.
  condition: and(succeeded(), or(eq(variables['Build.SourceBranch'], 'refs/heads/master'), or(eq(variables['Build.SourceBranch'], 'refs/heads/develop'), eq('true', variables['ForcePushNuget']))))

- task: PublishBuildArtifacts@1
  displayName: 'Publish Artifact'
  inputs:
    PathtoPublish: '$(build.artifactstagingdirectory)'
  condition: succeededOrFailed()
